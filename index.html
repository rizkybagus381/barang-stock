<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Barcode Produk</title>
    <!-- Memuat Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat pustaka ZXing-JS untuk deteksi barcode kamera -->
    <script type="text/javascript" src="https://unpkg.com/@zxing/library@latest"></script>
    <!-- Memuat Font Awesome untuk ikon mata di password -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
    <style>
        /* Gaya kustom untuk font dan warna latar belakang */
        @import url('https://fonts.googleapis.com/css2?family=Inter&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            min-height: 100vh; /* Menggunakan min-height agar bisa di-scroll jika konten lebih panjang */
            overflow-y: auto; /* Memungkinkan scrolling vertikal untuk konten utama */
            background-color: #1a202c; /* Latar belakang body sangat gelap (dark gray) */
            color: #e2e8f0; /* Teks default terang */
        }
        /* Video background styles */
        .background-video {
            position: fixed;
            inset: 0;
            z-index: -1;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        /* Class untuk menyembunyikan video setelah login */
        .hide-video {
            display: none;
        }

        /* Gaya untuk tabel (main app) */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #4a5568; /* Garis bawah abu-abu lebih gelap */
        }
        th {
            background-color: #2d3748; /* Warna abu-abu gelap untuk header tabel */
            color: #cbd5e0; /* Teks terang */
            font-weight: 600; /* Sedikit lebih tebal */
        }
        tr:hover {
            background-color: #2c3546; /* Warna abu-abu sedikit lebih gelap saat di-hover */
        }
        /* Responsif untuk tabel di layar kecil */
        @media (max-width: 768px) {
            table, thead, tbody, th, td, tr {
                display: block;
            }
            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            tr {
                border: 1px solid #4a5568;
                margin-bottom: 15px;
                border-radius: 12px; /* Sudut membulat yang lebih besar */
                overflow: hidden;
                box-shadow: 0 1px 3px rgba(0,0,0,0.2); /* Bayangan halus untuk dark mode */
                background-color: #2d3748; /* Background untuk baris di mobile */
            }
            td {
                border: none;
                border-bottom: 1px solid #4a5568;
                position: relative;
                padding-left: 50%;
                text-align: right;
            }
            td:before {
                position: absolute;
                top: 0;
                left: 6px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                color: #a0aec0; /* Warna label yang sedikit berbeda */
            }
            /* Label untuk setiap kolom di mode mobile */
            td:nth-of-type(1):before { content: "Barcode:"; }
            td:nth-of-type(2):before { content: "Nama Produk:"; }
            td:nth-of-type(3):before { content: "Kategori:"; }
            td:nth-of-type(4):before { content: "Harga Satuan:"; }
            td:nth-of-type(5):before { content: "Jumlah:"; }
            td:nth-of-type(6):before { content: "Total Harga:"; }
            td:nth-of-type(7):before { content: "Aksi:"; }
        }

        /* Gaya untuk area kamera (main app) */
        #mainCameraContainer {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            background-color: #000;
        }
        #mainCameraVideo {
            width: 100%;
            height: auto;
            display: block;
            object-fit: cover;
        }
        #mainCameraCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
        }
        .scanner-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80%;
            height: 30%;
            transform: translate(-50%, -50%);
            border: 2px solid #a855f7;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
            pointer-events: none;
            z-index: 5;
            border-radius: 12px;
        }
        .scanner-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(to right, transparent, #a855f7, transparent);
            animation: scan 2s infinite linear;
            z-index: 6;
        }

        /* Gaya untuk modal konfirmasi hapus */
        #deleteConfirmationModal {
            position: fixed;
            inset: 0; /* Menggunakan inset:0 sebagai ganti top,left,right,bottom:0 */
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #deleteConfirmationModal.show {
            opacity: 1;
            visibility: visible;
        }
        #deleteConfirmationContent {
            background-color: #2d3748;
            color: #e2e8f0;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        #deleteConfirmationModal.show #deleteConfirmationContent {
            transform: translateY(0);
        }

        /* Input field focus style (main app) */
        input {
            background-color: #2d3748;
            color: #e2e8f0;
            border-color: #4a5568;
        }
        input::placeholder {
            color: #a0aec0;
        }
        input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.4);
            background-color: #2d3748;
        }

        /* Select box styles (main app) */
        select {
            background-color: #2d3748;
            color: #e2e8f0;
            border-color: #4a5568;
        }
        select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.4);
        }
        /* Login specific styles - from user's provided HTML */
        #login-form-container { /* This is the bg-black bg-opacity-90 div */
            background-color: rgba(0, 0, 0, 0.9);
            border-radius: 32px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            width: 320px;
            height: 480px; /* Tinggi fix untuk menjaga proporsi seperti gambar */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; /* Memusatkan konten secara vertikal */
            padding: 2rem;
        }
        @media (min-width: 640px) { /* sm breakpoint */
            #login-form-container {
                width: 360px;
            }
        }
        .login-input-new { /* Renamed to avoid conflict with existing 'login-input' in style tag */
            background-color: transparent;
            border: 1px solid #9CA3AF; /* gray-400 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.5rem 1rem; /* px-4 py-2 */
            font-size: 0.75rem; /* text-xs */
            color: #F9FAFB; /* text-white */
            outline: none;
            font-weight: 400; /* Normal font weight */
            transition: all 0.2s ease-in-out;
            text-transform: uppercase; /* text-transform: uppercase; */
        }
        .login-input-new::placeholder {
            color: #F9FAFB; /* placeholder-white */
        }
        .login-input-new:focus {
            outline: none;
            ring: 1px;
            ring-color: #9CA3AF; /* focus:ring-1 focus:ring-gray-400 */
        }

        .login-button-new { /* Renamed to avoid conflict */
            background-color: #F3F4F6; /* gray-100 */
            color: #1F2937; /* text-black (custom dark for button) */
            font-size: 0.75rem; /* text-xs */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.5rem 0.75rem; /* py-2 px-3 */
            font-weight: 400; /* font-normal */
            transition: all 0.2s ease-in-out;
        }
        .login-button-new:hover {
            background-color: #E5E7EB; /* Lighter gray on hover */
            transform: translateY(-1px);
        }
        /* Icon styling from Font Awesome (fas fa-eye-slash) */
        .fa-eye-slash, .fa-eye {
            color: #9CA3AF; /* gray-400 */
            font-size: 0.875rem; /* text-sm */
        }
    </style>
</head>
<body class="bg-gray-900 flex items-center justify-center min-h-screen">

    <!-- Video Background -->
    <video id="backgroundVideo" autoplay muted loop playsinline class="background-video" aria-label="Abstract colorful animated video background with smooth gradient tones">
        <!-- Menggunakan URL video dari codingan yang diberikan pengguna -->
        <source src="https://s8.ezgif.com/tmp/ezgif-84c9f442c94bc.mp4" type="video/mp4"/>
        Your browser does not support the video tag.
    </video>

    <!-- Layar Login -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center fixed inset-0 z-10">
        <div id="login-form-container" class="w-[320px] sm:w-[360px]">
            <!-- Menggunakan URL gambar GIF dari codingan yang diberikan pengguna -->
            <img alt="Animated colorful circular logo GIF with swirling blue and purple tones" class="mb-10 w-24 h-24 rounded-full" height="100" src="https://i.pinimg.com/originals/e5/d6/8b/e5d68b4c0923839b89fefb727afb9742.gif" width="100"/>
            
            <form id="loginForm" class="w-full space-y-4"> <!-- Added id="loginForm" -->
                <input class="login-input-new w-full" id="usernameInput" type="text" placeholder="USERNAME" value=""/>
                <div class="relative">
                    <input class="login-input-new w-full pr-10" id="passwordInput" type="password" placeholder="PASSWORD" value=""/>
                    <i id="togglePassword" class="fas fa-eye-slash absolute right-3 top-1/2 -translate-y-1/2 cursor-pointer"></i>
                </div>
                <p class="text-red-400 mb-4 text-xs text-center" id="loginErrorMessage"></p>
                <div class="text-center text-[9px] text-white mb-4 select-none">
                    LUPA KATA SANDI?
                </div>
                <button type="button" id="signInButton" class="login-button-new w-full"> <!-- Changed type to "button" -->
                    MASUK
                </button>
            </form>
            <div class="text-[7px] text-gray-700 mt-6 select-none">
                VERSION 6.2.0
            </div>
        </div>
    </div>

    <!-- Konten Aplikasi Utama (Awalnya Tersembunyi) -->
    <div id="mainAppContent" class="bg-gray-800 p-6 rounded-2xl shadow-xl w-full max-w-4xl border border-gray-700 hidden relative z-0">
        <h1 class="text-3xl font-bold text-white mb-6 text-center">Sistem Data Barcode Produk Jadi</h1>

        <!-- Area User ID -->
        <div class="mb-6 p-4 bg-blue-900 rounded-xl border border-blue-800 shadow-sm text-center">
            <p class="text-white text-sm">User ID: <span id="userIdDisplay" class="font-mono text-blue-300 break-all">Memuat...</span></p>
            <p class="text-white text-xs mt-1">Data yang ditampilkan bersifat publik untuk aplikasi ini.</p>
        </div>

        <!-- Area Deteksi Kamera Barcode -->
        <div class="mb-8 p-6 bg-gray-700 rounded-xl border border-gray-600 shadow-sm">
            <h2 class="text-xl font-semibold text-gray-200 mb-4 text-center">Pindai Barcode dengan Kamera</h2>
            <div id="mainCameraContainer" class="relative mb-4 hidden">
                <video id="mainCameraVideo" class="rounded-lg"></video>
                <canvas id="mainCameraCanvas" class="hidden"></canvas>
                <div class="scanner-frame">
                    <div class="scanner-line"></div>
                </div>
            </div>
            <div id="mainCameraMessage" class="text-gray-300 mb-4 text-center"></div>
            <select id="mainCameraSelect" class="p-3 border border-gray-600 rounded-lg mb-3 w-full max-w-xs mx-auto block"></select>
            <div class="flex flex-col sm:flex-row justify-center gap-3">
                <button id="startMainCameraButton"
                        class="bg-purple-700 hover:bg-purple-800 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    Mulai Pindai Kamera Barcode
                </button>
                <button id="stopMainCameraButton"
                        class="bg-red-700 hover:bg-red-800 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 hidden">
                    Berhenti Pindai Barcode
                </button>
            </div>
        </div>

        <!-- Formulir Input Barcode dan Produk -->
        <div class="mb-8 p-6 bg-gray-700 rounded-xl border border-gray-600 shadow-sm">
            <h2 class="text-xl font-semibold text-gray-200 mb-4 text-center">Input/Perbarui Detail Produk</h2>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-4">
                <div>
                    <label for="barcodeInput" class="block text-sm font-medium text-gray-300 mb-1">Barcode Produk:</label>
                    <input type="text" id="barcodeInput" placeholder="Pindai atau masukkan barcode"
                           class="w-full p-3 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-200 shadow-sm">
                </div>
                <div>
                    <label for="productNameInput" class="block text-sm font-medium text-gray-300 mb-1">Nama Produk:</label>
                    <input type="text" id="productNameInput" placeholder="Masukkan nama produk"
                           class="w-full p-3 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-200 shadow-sm">
                </div>
                <div>
                    <label for="productCategoryInput" class="block text-sm font-medium text-gray-300 mb-1">Kategori Produk:</label>
                    <input type="text" id="productCategoryInput" placeholder="Contoh: Makanan, Minuman"
                           class="w-full p-3 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-200 shadow-sm">
                </div>
                <div>
                    <label for="productUnitPriceInput" class="block text-sm font-medium text-gray-300 mb-1">Harga Satuan (Rp):</label>
                    <input type="number" id="productUnitPriceInput" placeholder="Masukkan harga satuan"
                           class="w-full p-3 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-200 shadow-sm">
                </div>
                <div>
                    <label for="productQuantityInput" class="block text-sm font-medium text-gray-300 mb-1">Jumlah Awal/Manual:</label>
                    <input type="number" id="productQuantityInput" placeholder="Contoh: 30" value="1" min="0"
                           class="w-full p-3 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-200 shadow-sm">
                </div>
            </div>
            <div class="flex flex-col sm:flex-row gap-3">
                <button id="saveProductButton"
                        class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    Tambah/Perbarui Produk
                </button>
                <button id="clearInputButton"
                        class="w-full sm:w-auto bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    Bersihkan Input
                </button>
            </div>
            <p id="messageArea" class="mt-4 text-center font-medium"></p>
        </div>

        <!-- Area Total Barang dan Harga -->
        <div class="mb-8 p-6 bg-green-700 rounded-xl border border-green-600 shadow-sm text-center">
            <h2 class="text-xl font-semibold text-white mb-4">Ringkasan Barang</h2>
            <div class="flex justify-around items-center text-lg font-bold text-white">
                <p>Total Barang: <span id="totalItemsDisplay" class="text-green-300">0</span></p>
                <p>Total Harga: <span id="totalPriceDisplay" class="text-green-300">Rp 0</span></p>
            </div>
        </div>

        <!-- Tabel Daftar Produk -->
        <div class="p-6 bg-gray-700 rounded-xl border border-gray-600 overflow-x-auto shadow-sm">
            <h2 class="text-xl font-semibold text-gray-200 mb-4 text-center">Daftar Produk</h2>
            <table id="productTable" class="min-w-full divide-y divide-gray-600 rounded-lg overflow-hidden">
                <thead class="bg-gray-600 text-gray-200">
                    <tr>
                        <th class="py-3 px-6 text-left text-sm font-medium uppercase tracking-wider rounded-tl-lg">Barcode</th>
                        <th class="py-3 px-6 text-left text-sm font-medium uppercase tracking-wider">Nama Produk</th>
                        <th class="py-3 px-6 text-left text-sm font-medium uppercase tracking-wider">Kategori</th>
                        <th class="py-3 px-6 text-left text-sm font-medium uppercase tracking-wider">Harga Satuan</th>
                        <th class="py-3 px-6 text-left text-sm font-medium uppercase tracking-wider">Jumlah</th>
                        <th class="py-3 px-6 text-left text-sm font-medium uppercase tracking-wider">Total Harga</th>
                        <th class="py-3 px-6 text-left text-sm font-medium uppercase tracking-wider">Aksi</th>
                    </tr>
                </thead>
                <tbody id="productTableBody" class="bg-gray-700 divide-y divide-gray-600">
                    <!-- Produk akan ditambahkan di sini melalui JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal Konfirmasi Hapus -->
    <div id="deleteConfirmationModal" class="hidden">
        <div id="deleteConfirmationContent" class="p-8 bg-gray-700 rounded-2xl shadow-2xl">
            <h3 class="text-xl font-bold text-white mb-4">Konfirmasi Hapus Produk</h3>
            <p id="deleteProductMessage" class="text-gray-200 mb-6">Anda yakin ingin menghapus produk ini?</p>
            <div class="flex justify-center gap-4">
                <button id="confirmDeleteButton"
                        class="bg-red-700 hover:bg-red-800 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    Ya, Hapus
                </button>
                <button id="cancelDeleteButton"
                        class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    Batal
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, collection, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD-JgJAv0ZBPzEGW3cSmvVWTfY4Sy12B_g",
            authDomain: "hitungan-stok-barcode.firebaseapp.com",
            projectId: "hitungan-stok-barcode", 
            storageBucket: "hitungan-stok-barcode.firebasestorage.app",
            messagingSenderId: "880501835759",
            appId: "1:880501835759:web:6f25176906215cc36e581a",
            measurementId: "G-1TBDBV22HM"
        };
        // Use global variables for app_id and firebase_config if available
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const runtimeFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;

        // Initialize Firebase
        const app = initializeApp(runtimeFirebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null; 
        let productsCollectionRef = null; 
        let unsubscribeFromFirestore = null; 
        let products = [];
        let productToDeleteBarcode = null; 
        
        // --- HTML Elements ---
        // Login Screen Elements
        const loginScreen = document.getElementById('loginScreen');
        const usernameInput = document.getElementById('usernameInput');
        const passwordInput = document.getElementById('passwordInput');
        const togglePassword = document.getElementById('togglePassword');
        const signInButton = document.getElementById('signInButton');
        const loginErrorMessage = document.getElementById('loginErrorMessage');
        const loginForm = document.getElementById('loginForm'); // Reference to the form element
        const backgroundVideo = document.getElementById('backgroundVideo'); // Reference to the video element

        // Main App Elements
        const mainAppContent = document.getElementById('mainAppContent');
        const barcodeInput = document.getElementById('barcodeInput');
        const productNameInput = document.getElementById('productNameInput');
        const productCategoryInput = document.getElementById('productCategoryInput');
        const productUnitPriceInput = document.getElementById('productUnitPriceInput');
        const productQuantityInput = document.getElementById('productQuantityInput');
        const saveProductButton = document.getElementById('saveProductButton');
        const clearInputButton = document.getElementById('clearInputButton');
        const productTableBody = document.getElementById('productTableBody');
        const messageArea = document.getElementById('messageArea');
        const totalItemsDisplay = document.getElementById('totalItemsDisplay');
        const totalPriceDisplay = document.getElementById('totalPriceDisplay');
        const userIdDisplay = document.getElementById('userIdDisplay');

        // Camera Elements (for barcode scanning)
        const mainCameraVideo = document.getElementById('mainCameraVideo');
        const mainCameraCanvas = document.getElementById('mainCameraCanvas');
        const mainCameraContainer = document.getElementById('mainCameraContainer');
        const mainCameraMessage = document.getElementById('mainCameraMessage');
        const mainCameraSelect = document.getElementById('mainCameraSelect');
        const startMainCameraButton = document.getElementById('startMainCameraButton');
        const stopMainCameraButton = document.getElementById('stopMainCameraButton');

        // Modals
        const deleteConfirmationModal = document.getElementById('deleteConfirmationModal');
        const deleteProductMessage = document.getElementById('deleteProductMessage');
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');
        const cancelDeleteButton = document.getElementById('cancelDeleteButton');

        let codeReader; // ZXing CodeReader object

        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioContext = AudioContext ? new AudioContext() : null;

        // --- Core Utility Functions ---
        function playBeep() { /* ... (same as before) ... */
            if (!audioContext) { console.warn('Web Audio API not supported.'); return; }
            if (audioContext.state === 'suspended') { audioContext.resume(); }
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.type = 'sine';
            oscillator.frequency.value = 2000;
            gainNode.gain.setValueAtTime(1.0, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.08); 
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.08);
        }

        function showMessage(msg, type = 'info') { /* ... (same as before) ... */
            messageArea.textContent = msg;
            if (type === 'success') {
                messageArea.className = 'mt-4 text-center font-medium text-green-400';
            } else if (type === 'error') {
                messageArea.className = 'mt-4 text-center font-medium text-red-400';
            } else {
                messageArea.className = 'mt-4 text-center font-medium text-gray-300';
            }
        }

        function showCameraMessage(msg, type = 'info') { /* ... (same as before) ... */
            const targetMessageArea = mainCameraMessage;
            targetMessageArea.textContent = msg;
            if (type === 'error') {
                targetMessageArea.className = 'text-red-400 mb-4';
            } else {
                targetMessageArea.className = 'text-gray-300 mb-4';
            }
        }

        function clearInputs() { /* ... (same as before) ... */
            barcodeInput.value = '';
            productNameInput.value = '';
            productCategoryInput.value = '';
            productUnitPriceInput.value = '';
            productQuantityInput.value = 1;
            showMessage('');
            barcodeInput.focus();
        }

        function renderProductTable() { /* ... (same as before) ... */
            console.log("[DEBUG] renderProductTable: Rendering table. Current products:", products);
            productTableBody.innerHTML = '';

            if (products.length === 0) {
                const row = productTableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 7;
                cell.className = 'py-4 text-center text-gray-400 italic';
                cell.textContent = 'Belum ada produk yang ditambahkan.';
                updateTotals();
                return;
            }

            const sortedProducts = [...products].sort((a, b) => a.barcode.localeCompare(b.barcode));

            sortedProducts.forEach(product => {
                const row = productTableBody.insertRow(); // Menggunakan productTableBody
                row.className = 'hover:bg-gray-600 transition duration-150 ease-in-out';

                const barcodeCell = row.insertCell();
                barcodeCell.textContent = product.barcode;
                barcodeCell.className = 'py-3 px-6 text-sm text-gray-200';

                const nameCell = row.insertCell();
                nameCell.textContent = product.name;
                nameCell.className = 'py-3 px-6 text-sm text-gray-200';

                const categoryCell = row.insertCell();
                categoryCell.textContent = product.category;
                categoryCell.className = 'py-3 px-6 text-sm text-gray-200';

                const unitPriceCell = row.insertCell();
                unitPriceCell.textContent = 'Rp ' + product.unitPrice.toLocaleString('id-ID');
                unitPriceCell.className = 'py-3 px-6 text-sm text-gray-200';

                const quantityCell = row.insertCell();
                quantityCell.textContent = product.quantity;
                quantityCell.className = 'py-3 px-6 text-sm text-gray-200';

                const totalPriceItemCell = row.insertCell();
                totalPriceItemCell.textContent = 'Rp ' + (product.unitPrice * product.quantity).toLocaleString('id-ID');
                totalPriceItemCell.className = 'py-3 px-6 text-sm text-gray-200';

                const actionCell = row.insertCell();
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Hapus';
                deleteButton.className = 'bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg text-xs shadow-md transition duration-300 ease-in-out transform hover:scale-105';
                deleteButton.onclick = () => showDeleteConfirmation(product.barcode, product.name);
                actionCell.appendChild(deleteButton);
                actionCell.className = 'py-3 px-6 text-sm text-gray-200';
            });
            updateTotals();
        }

        async function handleBarcodeScan(barcodeValue) { /* ... (same as before) ... */
            playBeep();
            const barcode = barcodeValue.trim();
            console.log("[DEBUG] handleBarcodeScan: Processing barcode:", barcode);

            if (!barcode || !productsCollectionRef) {
                showMessage('Sistem belum siap atau barcode kosong.', 'error');
                return;
            }

            try {
                const existingProduct = products.find(p => p.barcode === barcode);
                console.log("[DEBUG] handleBarcodeScan: Existing product found locally:", existingProduct);

                if (existingProduct) {
                    const newQuantity = existingProduct.quantity + 1;
                    const productDocRef = doc(productsCollectionRef, barcode);
                    await setDoc(productDocRef, { quantity: newQuantity }, { merge: true });
                    showMessage(`Kuantitas "${existingProduct.name}" (Barcode: ${barcode}) ditingkatkan menjadi ${newQuantity}.`, 'success');
                    fillFormWithProductDetails({ ...existingProduct, quantity: newQuantity });
                } else {
                    barcodeInput.value = barcode;
                    productNameInput.value = '';
                    productCategoryInput.value = '';
                    productUnitPriceInput.value = '';
                    productQuantityInput.value = 1;
                    showMessage(`Barcode "${barcode}" terdeteksi. Harap lengkapi detail produk baru dan klik 'Tambah/Perbarui Produk'.`, 'info');
                }
            } catch (e) {
                console.error("Error handling barcode scan:", e);
                showMessage(`Gagal memproses barcode: ${e.message}`, 'error');
            } finally {
                barcodeInput.focus();
            }
        }

        function fillFormWithProductDetails(product) { /* ... (same as before) ... */
            console.log("[DEBUG] fillFormWithProductDetails: Filling form with product:", product);
            if (product) {
                barcodeInput.value = product.barcode;
                productNameInput.value = product.name;
                productCategoryInput.value = product.category;
                productUnitPriceInput.value = product.unitPrice;
                productQuantityInput.value = product.quantity;
            } else {
                clearInputs();
            }
        }

        async function processFormSubmission() { /* ... (same as before) ... */
            const barcode = barcodeInput.value.trim();
            const name = productNameInput.value.trim();
            const category = productCategoryInput.value.trim();
            const unitPrice = parseFloat(productUnitPriceInput.value);
            const quantity = parseInt(productQuantityInput.value);

            console.log("[DEBUG] processFormSubmission: Barcode:", barcode, "Quantity:", quantity);

            if (!barcode || !name || !category || isNaN(unitPrice) || unitPrice <= 0 || isNaN(quantity) || quantity < 0 || !productsCollectionRef) {
                showMessage('Harap isi semua kolom dengan benar dan pastikan sistem siap.', 'error');
                return;
            }

            try {
                const productDocRef = doc(productsCollectionRef, barcode);
                const productData = { barcode, name, category, unitPrice, quantity };

                await setDoc(productDocRef, productData, { merge: true });
                
                showMessage(`Produk "${name}" (Barcode: ${barcode}) berhasil ${products.some(p => p.barcode === barcode) ? 'diperbarui' : 'ditambahkan'}.`, 'success');
            }
            catch (e) {
                console.error("Error processing form submission:", e);
                showMessage(`Gagal menyimpan produk: ${e.message}`, 'error');
            } finally {
                clearInputs();
            }
        }

        function updateTotals() { /* ... (same as before) ... */
            let totalItems = 0;
            let totalPrice = 0;
            products.forEach(product => {
                totalItems += product.quantity;
                totalPrice += (product.unitPrice * product.quantity);
            });

            totalItemsDisplay.textContent = totalItems;
            totalPriceDisplay.textContent = 'Rp ' + totalPrice.toLocaleString('id-ID');
        }

        function showDeleteConfirmation(barcode, productName) { /* ... (same as before) ... */
            productToDeleteBarcode = barcode;
            deleteProductMessage.textContent = `Anda yakin ingin menghapus produk "${productName}" (Barcode: ${barcode}) dan semua kuantitasnya dari daftar?`;
            deleteConfirmationModal.classList.remove('hidden');
            setTimeout(() => deleteConfirmationModal.classList.add('show'), 10);
        }

        function hideDeleteConfirmation() { /* ... (same as before) ... */
            productToDeleteBarcode = null;
            deleteConfirmationModal.classList.remove('show');
            deleteConfirmationModal.addEventListener('transitionend', function handler() {
                deleteConfirmationModal.classList.add('hidden');
                deleteConfirmationModal.removeEventListener('transitionend', handler);
            });
        }

        async function deleteProduct() { /* ... (same as before) ... */
            if (productToDeleteBarcode && productsCollectionRef) {
                try {
                    const productDocRef = doc(productsCollectionRef, productToDeleteBarcode);
                    await deleteDoc(productDocRef);
                    showMessage(`Produk dengan barcode "${productToDeleteBarcode}" berhasil dihapus.`, 'success');
                }
                catch (e) {
                    console.error("Error deleting product:", e);
                    showMessage(`Gagal menghapus produk: ${e.message}`, 'error');
                } finally {
                    hideDeleteConfirmation();
                }
            } else {
                hideDeleteConfirmation();
            }
        }

        // --- Camera Barcode Scanner Functions ---
        codeReader = new ZXing.BrowserMultiFormatReader();

        async function populateMainCameraSelection() { /* ... (same as before) ... */
            if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
                showCameraMessage('Browser Anda tidak mendukung akses kamera.', 'error');
                startMainCameraButton.disabled = true; return;
            }
            try {
                const videoInputDevices = await codeReader.listVideoInputDevices();
                mainCameraSelect.innerHTML = '';
                if (videoInputDevices.length > 0) {
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'Kamera Default';
                    mainCameraSelect.appendChild(defaultOption);

                    videoInputDevices.forEach((device, index) => {
                        const option = document.createElement('option');
                        option.value = device.deviceId;
                        option.textContent = device.label || `Kamera ${index + 1}`; 
                        mainCameraSelect.appendChild(option);
                    });
                    mainCameraSelect.style.display = 'block';
                    showCameraMessage('Pilih kamera dari daftar atau gunakan kamera default.', 'info'); 
                } else {
                    showCameraMessage('Tidak ada kamera yang ditemukan.', 'error');
                    mainCameraSelect.style.display = 'none'; startMainCameraButton.disabled = true;
                }
            } catch (err) {
                console.error('Error getting main camera devices:', err);
                showCameraMessage(`Gagal mengakses kamera: ${err.message || err.name}.`, 'error');
                startMainCameraButton.disabled = true;
            }
        }

        let selectedMainCameraDeviceId = null;

        async function startMainCameraScanning() { /* ... (same as before) ... */
            showCameraMessage('Memulai kamera barcode...');
            startMainCameraButton.disabled = true;

            const currentSelectedDeviceId = mainCameraSelect.value;
            selectedMainCameraDeviceId = currentSelectedDeviceId === '' ? undefined : currentSelectedDeviceId;

            if (!selectedMainCameraDeviceId && mainCameraSelect.options.length > 1) { 
                showCameraMessage('Harap pilih kamera dari daftar.', 'error');
                startMainCameraButton.disabled = false;
                return;
            }
            
            try {
                showCameraMessage('Kamera barcode aktif. Arahkan ke barcode.', 'info');
                mainCameraContainer.classList.remove('hidden'); stopMainCameraButton.classList.remove('hidden');
                
                codeReader.decodeFromVideoDevice(selectedMainCameraDeviceId, mainCameraVideo, async (result, err) => {
                    if (result) {
                        console.log("[DEBUG] Main camera detected barcode:", result.text);
                        await handleBarcodeScan(result.text);
                        stopMainCameraScanning();
                    }
                    if (err && !(err instanceof ZXing.NotFoundException)) {
                        console.error('Main camera scanning error:', err);
                        showCameraMessage(`Gagal memindai barcode: ${err.message || err.name}.`, 'error');
                    }
                });
            } catch (err) {
                console.error('Error starting main camera scan:', err);
                if (err.name === "OverconstrainedError") {
                    showCameraMessage("Gagal memulai kamera: Resolusi atau fitur kamera tidak didukung. Coba pilih 'Kamera Default'.", 'error');
                } else if (err.name === 'NotAllowedError') {
                    showCameraMessage('Akses kamera ditolak. Harap izinkan akses kamera di pengaturan browser Anda.', 'error');
                } else if (err.name === 'NotFoundError') {
                    showCameraMessage('Tidak ada kamera yang ditemukan. Pastikan kamera terhubung.', 'error');
                } else if (err.name === 'NotReadableError') {
                     showCameraMessage('Kamera sedang digunakan atau tidak dapat diakses. Coba tutup aplikasi lain yang mungkin menggunakan kamera.', 'error');
                }
                else {
                    showCameraMessage(`Gagal memulai kamera: ${err.message || err.name}.`, 'error');
                }
                stopMainCameraScanning();
            }
        }

        function stopMainCameraScanning() { /* ... (same as before) ... */
            codeReader.reset();
            startMainCameraButton.disabled = false;
            stopMainCameraButton.classList.add('hidden');
            mainCameraContainer.classList.add('hidden');
            showCameraMessage('Pemindaian barcode berhenti.');
        }


        // --- Firebase Initialization and Data Listener ---
        async function initializeFirebaseAndLoadData() { /* ... (same as before) ... */
            try {
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("[Firebase] Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("[Firebase] Signed in anonymously.");
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        console.log("[Firebase] User authenticated. UID:", userId);

                        const specificAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                        productsCollectionRef = collection(db, `artifacts/${specificAppId}/public/data/products_data`);
                        console.log("[Firebase] Firestore collection path:", `artifacts/${specificAppId}/public/data/products_data`);

                        if (unsubscribeFromFirestore) {
                            unsubscribeFromFirestore();
                        }
                        const q = query(productsCollectionRef);
                        unsubscribeFromFirestore = onSnapshot(q, (snapshot) => {
                            const fetchedProducts = [];
                            snapshot.forEach((doc) => {
                                fetchedProducts.push(doc.data());
                            });
                            products = fetchedProducts;
                            renderProductTable();
                            console.log("[Firebase] Data updated from Firestore:", products);
                        }, (error) => {
                            console.error("[Firebase] Error listening to Firestore:", error);
                            showMessage(`Gagal memuat data: ${error.message}`, 'error');
                        });

                    } else {
                        userId = null;
                        userIdDisplay.textContent = 'Tidak Terautentikasi';
                        console.log("[Firebase] User is signed out or not authenticated.");
                        if (unsubscribeFromFirestore) {
                            unsubscribeFromFirestore();
                            unsubscribeFromFirestore = null;
                        }
                        products = [];
                        renderProductTable();
                        showMessage('Harap masuk untuk memuat data.', 'info');
                    }
                });

            } catch (error) {
                console.error("[Firebase] Error during Firebase initialization or authentication:", error);
                userIdDisplay.textContent = 'Error Autentikasi';
                showMessage(`Gagal terhubung ke Firebase: ${e.message}`, 'error');
            }
        }

        // --- Login Logic ---
        function handleLogin() {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            const correctUsername = "admin"; // Defined correct username
            const correctPassword = "admin123"; // Defined correct password

            if (username === correctUsername && password === correctPassword) {
                loginErrorMessage.textContent = ""; // Clear any previous error
                loginScreen.classList.add('hidden'); // Hide login screen
                mainAppContent.classList.remove('hidden'); // Show main app content
                backgroundVideo.classList.add('hide-video'); // Sembunyikan video background

                // Now that the main app is visible, initialize its components
                initializeFirebaseAndLoadData(); // Start Firebase init and data loading
                populateMainCameraSelection(); // Populate barcode camera selection
                barcodeInput.focus(); // Focus barcode input after login
            } else {
                loginErrorMessage.textContent = "Username atau password salah. Silakan coba lagi.";
            }
        }

        // --- Event Listeners ---
        // Login button and Enter key for login form
        signInButton.addEventListener('click', handleLogin);
        // Add event listener to the form's submit event to prevent default behavior
        loginForm.addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent default form submission (page reload)
            handleLogin(); // Call handleLogin function
        });

        passwordInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                // If Enter is pressed on password field, prevent default and try to log in
                event.preventDefault(); 
                handleLogin();
            }
        });
        usernameInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                passwordInput.focus();
            }
        });

        // Toggle password visibility
        togglePassword.addEventListener('click', function() {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            // Toggle Font Awesome eye icon
            if (type === 'password') {
                this.classList.add('fa-eye-slash');
                this.classList.remove('fa-eye');
            } else {
                this.classList.remove('fa-eye-slash');
                this.classList.add('fa-eye');
            }
        });


        saveProductButton.addEventListener('click', processFormSubmission);
        clearInputButton.addEventListener('click', clearInputs);
        barcodeInput.addEventListener('keypress', function(event) { if (event.key === 'Enter') { event.preventDefault(); handleBarcodeScan(barcodeInput.value); } });
        productNameInput.addEventListener('keypress', function(event) { if (event.key === 'Enter') { event.preventDefault(); productCategoryInput.focus(); } });
        productCategoryInput.addEventListener('keypress', function(event) { if (event.key === 'Enter') { event.preventDefault(); productUnitPriceInput.focus(); } }
        );
        productUnitPriceInput.addEventListener('keypress', function(event) { if (event.key === 'Enter') { event.preventDefault(); productQuantityInput.focus(); } });
        productQuantityInput.addEventListener('keypress', function(event) { if (event.key === 'Enter') { event.preventDefault(); processFormSubmission(); } });

        // Barcode scanner camera buttons
        startMainCameraButton.addEventListener('click', startMainCameraScanning);
        stopMainCameraButton.addEventListener('click', stopMainCameraScanning);
        mainCameraSelect.addEventListener('change', (event) => { 
            showCameraMessage(`Kamera ${event.target.options[event.target.selectedIndex].text} dipilih.`);
            stopMainCameraScanning(); 
        });
        
        confirmDeleteButton.addEventListener('click', deleteProduct);
        cancelDeleteButton.addEventListener('click', hideDeleteConfirmation);

        // Initialize on DOMContentLoaded: show login screen, focus username input
        document.addEventListener('DOMContentLoaded', async () => {
            // Initially show login screen and hide main app
            loginScreen.classList.remove('hidden');
            mainAppContent.classList.add('hidden');
            usernameInput.focus(); // Focus on username input on page load
            // Firebase and camera initialization for main app will happen ONLY after successful login
            // renderProductTable() is called by Firestore onSnapshot, so no need here.
        });

        // Ensure camera stream is stopped on page unload
        window.addEventListener('beforeunload', () => {
            stopMainCameraScanning();
            if (unsubscribeFromFirestore) {
                unsubscribeFromFirestore();
            }
        });
    </script>
</body>
</html>
